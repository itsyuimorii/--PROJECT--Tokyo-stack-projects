# üí•üë©üèª‚ÄçüíªBlog Management System

## Overview

## 1. Initialization

1. create the required folder for the project
   `public` Static resources
   `model` database operations
   `route` Routing
   `views` templates
2. initialize the project description file
   `npm init -y`.
3. download the required third-party modules for the project
   `npm install express mongoose art-template express-art-template`
4. create the web server

```js
// Referencing the expess framework
const express = require("express");
// Create the web server
const app = express();

app.listen("Server listening on http://localhost:80");
```

## 2. Routing

routerüìÅ-> admin.js

```js
// Blog administration page routing
const express = require(" express");

//create routes for blog administration
const admin = express.Router();

// Export the routing object as a member of the routing module
module.exports = admin;
```

routerüìÅ-> home.js

```js
// Blog display page routing

const express = require("express");
//create routes for blog display page

const home = express.Router();

home.get("/", (req, res) => {
  res.send("welcome to the home page");
});

// Export the routing object as a member of the routing module
module.exports = home;
```

app.js

```js
//import routes from router file
const homeRouter = require("./router/home");
const adminRouter = require("./router/admin");

// Match the first level request path to the routing object, introduce the routing module
app.use("/home", homeRouter);
app.use("/admin", adminRouter);
```

## 3. Static Resource

There are two folders in publicüìÅ, `admin` and` home`,  which are used for art files respectively 

```js
//Open Static Source File
app.use(express.static(path.join(__dirname, "public")));
```

```js
// Tell the express framework where the template is located
app.set('views', path.join(__dirname, 'views'));
// Tell the express framework template what the default suffix is
app.set('view engine', 'art');
// What template engine is used when rendering templates with the art suffix
app.engine('art', require('express-art-template'));
```

then jump to router üìÅ ->admin.js

```js
admin.get("/login", (req, res) => {
  res.render("admin/login");
});
```

Enter `localhost:3000/admin/login` in your browser and you will see the page rendered by `login.art`

![geekspace login](https://github.com/itsyuimorii/Tokyo-stack-projects/blob/main/images/geekspace%20login.png) 

### üí•External Chain Resources‚ö†Ô∏è

**The external link resource in template üìÉ, its relative path is relative to the request path in the browser**, Then this **request path** will change, not safe! So in the template to use the absolute path to represent the relative path, - **"/"** represents the **absolute path.** 

The relative path in the template is relative to the request path in the browser, so there is a problem here, if you change app.use`("/admin", adminRouter)` to `app.use("/abc", adminRouter)`, css üìÉ will not be found

So in the `login.art` file, you need to add `/admin/`

```js
<a href="/admin/lib/bootstrap/css/bootstrap.min.css" />
<link rel="stylesheet" href="/admin/css/base.css" />
      
<script src="/admin/lib/jquery/dist/jquery.min.js"></script>
<script src="/admin/lib/bootstrap/js/bootstrap.min.js"></script>
```

## 4. Optimization Template

ÊäΩÈõ¢admin‰∏≠ html üìÉË£°ÁöÑcommon part 

adminüìÅ-> commonüìÅ -> aside.art

```js
  <!-- Sidebar -->
  <div class="aside fl">
    <ul class="menu list-unstyled">
      <li>
        <a class="item active" href="user.html">
          <span class="glyphicon glyphicon-user"></span>
          User Management
        </a>
      </li>
          <li>
            <a class="item" href="article.html">
              <span class="glyphicon glyphicon-th-list"></span>
              Article Management
            </a>
          </li>
        </ul>
        <div class="cprt">
            Powered by
            <a href="https://itsyuimorii.github.io/" target="_blank"
              >itsyuimorii</a
            >
          </div>
      </div>
      <!-- Sidebar -->
```

>  header.art

```js
    <!-- header -->
    <div>
    <div class="header">
      <!-- logo -->
      <div class="logo fl">Geek <i>Space</i></div>
      <!-- /logo -->
      <!-- User Information -->
      <div class="info">
        <div class="profile dropdown fr">
          <span class="btn dropdown-toggle" data-toggle="dropdown">
            admin
            <span class="caret"></span>
          </span>
          <ul class="dropdown-menu">
            <li><a href="user-edit.html">Personal Information</a></li>
            <li><a href="#">Logout</a></li>
          </ul>
        </div>
      </div>
      <!-- /user information -->
    </div>
    <! -- /user information -->
</div>
<! -- /header -->
```

> layout.art

```js
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Blog - Content Manager</title>
    <link rel="stylesheet" href="/admin/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/admin/css/base.css">
    {{block 'link'}}{{/block}}
</head>

<body>
	{{block 'main'}} {{/block}}
	<script src="/admin/lib/jquery/dist/jquery.min.js"></script>
	<script src="/admin/lib/bootstrap/js/bootstrap.min.js"></script>
    <script src="/admin/js/common.js"></script>
	{{block 'script'}} {{/block}}
</body>

</html>
```

## 5. Database

> modelüìÅ ->connect.js

```js
const mongoose = require("mongoose");
// Connecting to the database
mongoose
  .connect("mongodb://localhost/blog", { useNewUrlParser: true })
  .then(() => console.log("Database connection successful"))
  .catch(() => console.log("Database connection failure"));

```

> modelüìÅ ->user.js

```js
const mongoose = require("mongoose");

//set collection rules
const userSchema = new mongoose.Schema({
  username: {
    type: String,
    required: true,
    minlength: 2,
    maxlength: 20,
  },
  email: {
    type: String,
    unique: true,
  },
  password: {
    type: String,
    required: true,
  },
  role: {
    type: String,
    required: true,
  },
  //0 is enabled, 1 is disabled
  state: {
    type: Number,
    default: 0,
  },
});

//set collection
const User = mongoose.model("User", userSchema);

module.exports = {
  User: User,
};
```

> user.js

```js
/*-----testing code here------*/
//set collection 

const User = mongoose.model("User", userSchema);

User.create({
  username: "admin",
  email: "admin@example.com",
  password: "000000",
  role: "admin",
  state: 0,
})
  .then(() => {
    console.log("user created successfully");
  })
  .catch(() => {
    console.log("error creating user");
  });  

```

> app.js

```js
//database connection
require("./model/connect");
//Create initial user
require("./model/user");
```

 ```bash
 node app.js 
 api server running at http://127.0.0.1:3000
 Database connection successful
 user created successfully
 ```

![database](https://github.com/itsyuimorii/Tokyo-stack-projects/blob/main/images/database.png)

## 6. Login 

### 1. Create a user collection and initialize users

- Connect to the database
- Create a collection of users
- Initialize users

### 2. Setup form action etc.

> set the ***request address**, **request method** and **form name attributes*** for the login form item

- Form submission needs to use `post`method, Because the post method to request parameters in the body, get is in the address bar to pass, not safe 

  > üìÅviews -> Login.art

```html
 <form action="/admin/login" method="post" id="loginForm">
 <input name ="email"...>
 <input name ="password"...>
```

### 3. Client Authentication

> when the user clicks the login button, the client ***verifies that the user*** has filled in the login form

- if one of the items is not entered, prevent the form from being submitted

a. **Block form default submission method**

```js
// Add a submit event to the form
<script type="text/javascript">
        $('#loginForm').on('submit', function () {
           return false;
        });
    </script>
```

b. ËôïÁêÜË°®ÂñÆÂÖ¨ÂÖ±ÊñπÊ≥ï `public->js->common.js`

```js

function serializeToJson(form) {
  var result = {};
  // [{name: 'email', value: 'User input'}]
  var f = form.serializeArray();
  f.forEach(function (item) {
    // result.email
    result[item.name] = item.value;
  });
  return result;
}
```

```js
//login.art
<script src="/admin/js/common.js"></script>
```

```js
    <script type="text/javascript">
        // Add a submit event to the form
        $('#loginForm').on('submit', function () {
            // Get the user input in the form
            var result = serializeToJson($(this))
            // If the user did not enter an email address
            if (result.email.trim().length == 0) {
                alert('Please enter an email address');
                // Stop the program from going down
                return false;
            }
            // If the user did not enter a password
            if (result.password.trim().length == 0) {
                alert('Please enter your password')
                // Stop the program from going down
                return false;
            }
        });
    </script>
```



### 4. Server side receives the request parameters from client side

> `app.js`
>
> Configure the module to handle the `post`request parameters

üí•`app.use` intercepts all requests and passes them to the `urlencoded` method under `body-parser`, with the required parameter: `extended:false` (will be processed using the system module `queryString`)

```js
//third_party import
const bodyParser = require("body-parser");
//Configure the post request parameter, body-parser parsing file
app.use(bodyParser.urlencoded({ extended: false }));
```

> `admin.js` 
>
> To receive the request parameters (password and username entered by the user), use the `body-parser`

```js
//login routes
admin.post("/login", (req, res) => {
  //Receive request parameters (password and user name entered by the user)
  res.send(req.body);
});
```

### 5. Server side Authentication

> `admin.js`
>
> Verifies that the user has filled in the login form again 

- if one of them is not entered, respond for the client and stop the program from executing further

 ```js
 admin.post("/login", (req, res) => {
   //Receive request parameters (password and user name entered by the user)
   res.send(req.body); //Receive request parameters from the client
   
   // Secondary verification of request parameters
   const { email, password } = req.body; 
 	//If the user does not enter an email address
   if (email.trim().length == 0 || password.trim().length == 0)
     return res.status(400).send("<h4>Incorrect email address or password</h4>");
 });
 ```

### 6. Optimize the error page

> `admin.js`

> Optimize the error page

```js
  if (email.trim().length == 0 || password.trim().length == 0)
    //return res.status(400).send("<h4>Incorrect email address or password</h4>");
    return res
      .status(400)
      .render("admin/error", { msg: "Incorrect email address or password}" });
});
```

> err.art

```js
{{extend './common/layout.art'}}

{{block 'main'}}
	<p class="bg-danger error">{{msg}}</p>
{{/block}}
```

> Set the error page to jump automatically-client side

```js
{{block 'script'}}
	<script type="text/javascript">
		setTimeout(function () {
			location.href = '/admin/login';
		}, 3000)
	</script>
{{/block}}
```

### 7. According to the user's email, check whether the user exists

1. Look up user information based on email address

   - Â∞á`model`üìÅË£°ÁöÑÁöÑ`user`ÈõÜÂêà‰ø°ÊÅØÂ∞éÂÖ•`router`üìÅ Ë£°ÁöÑ`admin.js` -> `admin.post`Ë∑ØÁî±

      ```js
      //import user set construction function
      const { User } = require("../model/user");
      ```

   - Get the parameters entered by the user

      ```js
      admin.post("/login", async (req, res) => {
      	//receive the request parameters
      	const { email, password } = req.body;
        
      .....
      ```

   - If the user does not enter an email address

      ```js
      // if (email.trim().length == 0 || password.trim().length == 0) return res.status(400).send('<h4>Incorrect email address or password</h4>');
        if (email.trim().length == 0 || password.trim().length == 0)
          return res
            .status(400)
            .render("admin/error", { msg: "Incorrect email address or password" });
      ```

   - If the user does not exist, **respond for the client** and prevent the program from executing downward

   - If the user exists, the user name and password are matched
   
      If the match is successful, the user logs in successfully
   
      If the comparison fails, the user fails to log in
   
      ```js
      let user = await User.findOne({ email });
        //Query the user
        if (user) {
          
          // Compare the password passed by the client with the password in the user information
          if (password == user.password) {
            // Login successfully
            res.send("Login successful");
          } else {
	         // No users were queried, Password Error
            res.status(400).render("admin/error", { msg: "Email address or password error" });
          }
        } else {
          // No user was queried
          res.status(400).render("admin/error", { msg: "Incorrect email address or password" });
        }
      });
      ```
      
   - Verify Third Party Package Passwordüîê bcrypt
   
      ```js
      const bcrypt = require("bcrypt");
      
      let isValid = await bcrypt.compare(password, user.password);
      ```
   
### 8. **bcrypt** module

1. Install 

  ```js
  node-gyp -g
  npm install -g node-gyp
  ```

  ```js
  // Import the bcrypt module
  const bcrypt = require('bcrypt');
  // generate a random string gen => generate generate salt salt
  let salt = await bcrypt.genSalt(10);
  // encrypt the password with a random string
  let pass = await bcrypt.hash('plaintext password', salt);
  ```

  ```js
  // Password comparison
  let isEqual = await bcrypt.compare('plaintext password', 'encrypted password');
  ```

2. Example `hash.js`

```js
// importing bcrypt
const bcrypt = require('bcrypt');


async function run () {
	// Generate a random string
	// The genSalt method takes a numeric value as an argument
	// The larger the value, the higher the complexity of the generated random string
	// the smaller the value, the lower the complexity of the generated random string
	// The default value is 10
	// Returns the generated random string
	const salt = await bcrypt.genSalt(10);
	// Encrypt the password
	// 1. the plaintext to be encrypted
	// 2. a random string
	// The return value is the encrypted password
	const result = await bcrypt.hash('123456', salt);
	console.log(salt);
	console.log(result);
}

run();// importing bcrypt
```

3. Create a new user, using bcrypt `model`üìÅ ->`User.js`

```js
/*-----testing code here------*/
//set collection
async function createUser() {
  const salt = await bcrypt.genSalt(10);
  const pass = await bcrypt.hash("000000", salt);
  const user = await User.create({
    username: "admin",
    email: "admin@example.com",
    password: pass,
    role: "admin",
    state: 0,
  });
}
createUser();
```

![bcrpyt](https://github.com/itsyuimorii/Tokyo-stack-projects/blob/main/images/bcrpyt.png)

4. Compare the passwords passed by the client with the passwords in the user information

```js
 if (user) {
    // Â∞ÜÂÆ¢Êà∑Á´Ø‰º†ÈÄíËøáÊù•ÁöÑÂØÜÁ†ÅÂíåÁî®Êà∑‰ø°ÊÅØ‰∏≠ÁöÑÂØÜÁ†ÅËøõË°åÊØîÂØπ
    // Search user information by email address
    // return boolean true or false
    let isValid = await bcrypt.compare(password, user.password);
    // If the password match is successful
    if (isValid) {
      // Login successful
      // Store the username in the request object
      req.username = user.username;
      res.send("Login successful");

      // Redirects to the user list page
      //res.redirect("/admin/user");
```

### üí•Fake Registration Problem

ÈÄôË£°ÂÑòÁÆ°Ëº∏ÂÖ•‰∫ÜÂØÜÁ¢ºÂíåÁî®Êà∂ÂêçÈ°ØÁ§∫ÁôªÈåÑÊàêÂäü,‰ΩÜÊòØÁï∂ÁôªÈåÑÂà∞http://127.0.0.1:3000/admin/user, ÊúÉÈ°ØÁ§∫`user not found`

testing code 

```html
 <h4>user{{msg? msg: "user is not found"}}</h4>
```

![Screen Shot 2023-02-15 at 3.00.49 PM](https://github.com/itsyuimorii/Tokyo-stack-projects/blob/main/images/fake%20user%20login.png)

> Here  need to introduce cookies and session

### 9. Cookie & session

- `cookie`: A **space** created by the browser on the computer's hard disk, mainly for storing data on the server side.
  - The data in the cookie is ***distinguished*** **in the form of domain.**
  - The data in the cookie **has an expiration date**, and the data will be ***deleted automatically*** by the browser after the expiration date.
  - The data in the cookie is ***automatically* sent to the server with the request**.
- `session`: it is actually an object, stored in the **server-side memory**, in the session object can also store multiple data, each data has a `session id` as a **unique identifier.**

![session](/Users/yuimorii/Documents/GitHub/Tokyo-stack-projects/images/session.png)

> middleware function, app.use intercepts all requests and passes them to the session method, 

How the method works internally: 

1. add an attribute to the request, wait for the user to log in, save the user information and generate the session id

2. store the session id in the client's cookie, and when the client accesses the server again, the attribute is a key value to store the information, 

**routerüìÅ->admin.js**

```js
const session = require("express-session");
admin.post("/login", async (req, res) => {
  ...
     if (isValid) {
      // login was successful
      // Store the username in the request object
      req.session.username = user.username;
      // res.send('Login successful');
      // redirect to user list page
      res.redirect("/admin/user");
    } else {
      // No users were queried
      res
        .status(400)
        .render("admin/error", { msg: "Incorrect email address or password" });
    }
  ...
```

### 10. How to expose the public data to the template? 

ÊääÊï∏ÊìöÊîæÂú®localsÂ∞çË±°‰∏≠, Â∞±ÂèØ‰ª•Êö¥Èú≤Áµ¶Ê®°Êùø, Â∞±‰∏çÁî®`res.render`Ê∏≤ÊüìÁµ¶Ê®°Êùø‰∫Ü

The **app.locals** object has properties that are local variables within the application. These variables are local to the application and are very useful.

**Syntax:**

```
app.locals
```

**routerüìÅ->admin.js**

```js
req.app.locals.userInfo = user;
```

ViewsüìÅ=>adminüìÅ=>commonüìÅ=> header.art

```html
 {{userInfo.username}}
```

### 11. Landing Interception

> When the user is not logged in, the administration page of the blog is not visible to the user



Âú® ViewsüìÅ=>adminüìÅ=>commonüìÅ=> header.art ‰∏ã, ÊîπÁÇ∫üëá

>ÂÖàÂà§Êñ∑ÊúâÊ≤íÊúâ`userinfo`, Â¶ÇÊûúÊúâÂÜçÁúã`username`

```
{{userInfo && userInfo.username}}
```

if not `/admin`, intercept request

`app.js ` \

> `const guard`  must be exist before route `app.use("/admin", adminRouter);`
>
> 1. Determining whether the user is visiting a login page
> 2. Determine the user's login status
>    1. If the user is logged in, the request is released
>    2. If the user is not logged in, redirect the request to the login page

```js
// Intercept requests to determine user login status
app.use('/admin', (req, res)=>{
	if (req.url != '/login' && !req.session.username) {
		res.redirect('/admin/login');
	} else {
		// User is logged in Release the request
		next();
	}
}
module.exports = guard;
}

//import routing module
//Match the first level request path to the routing object,
app.use("/home", homeRouter);
app.use("/admin", adminRouter);
```

### 12. Optimized middleware code

middlewareüìÅ => loginGuard

```js
const guard = (req, res, next) => {
  /* 
1. Determining whether the user is visiting a login page
2. Determine the user's login status
   1. If the user is logged in, the request is released
   2. If the user is not logged in, redirect the request to the login page */

  if (req.url != "/login" && !req.session.username) {
    res.redirect("/admin/login");
  } else {
    // User is logged in Release the request
    next();
  }
};
module.exports = guard;
```

```js
// Intercept requests to determine user login status
app.use("/admin", require("./middleware/loginGuard"));
```

### 13. Separate Routing Code

RouterüìÅ -> login.js

```js
//login routes
admin.post("/login", require("./admin/login"));
```

RouterüìÅ -> adminüìÅ -> login.js

```js
//import user set construction function from database

const { User } = require("../../model/user");
const bcrypt = require("bcrypt");

module.exports = async (req, res) => {
  //Receive request parameters (password and user name entered by the user)
  //res.send(req.body); //Receive request parameters from the client

  // Secondary verification
  //receive the request parameters
  const { email, password } = req.body;
  //If the user does not enter an email address
  // if (email.trim().length == 0 || password.trim().length == 0) return res.status(400).send('<h4>Incorrect email address or password</h4>');
  if (email.trim().length == 0 || password.trim().length == 0)
    return res
      .status(400)
      .render("admin/error", { msg: "Incorrect email address or password" });
  //-------Search user information by email address-------
  // If the user is queried, the value of the user variable is an object type, and the object stores the user's information.
  // If the user is not queried, the user variable is empty.
  let user = await User.findOne({ email });
  // The user is queried
  if (user) {
    // Match the password passed by the client with the password in the user information // Search user information by email address
    // true The comparison is successful
    // false Failed to match
    let isValid = await bcrypt.compare(password, user.password);
    // if the password match is successful
    if (isValid) {
      // login was successful
      // Store the username in the request object
      req.session.username = user.username;
      //res.send("Login successful");
      req.app.locals.userInfo = user;
      // redirect to user list page
      res.redirect("/admin/user");
    } else {
      // No users were queried
      res
        .status(400)
        .render("admin/error", { msg: "Incorrect email address or password" });
    }
  } else {
    // No user is queried
    res
      .status(400)
      .render("admin/error", { msg: "Incorrect email address or password" });
  }
};

```

### 14.Stages Code

LOCATION : [Step01_login](https://github.com/itsyuimorii/Tokyo-stack-projects/tree/main/05.FinalProject-blog_management_system/Step01_login)

## 7. addUsers

> Adding a user is an action that  insert to database, so use `post`

1. Create a link to the Add User button on the user list page

2. Create a link to the corresponding route and render the new user template in the route handler function

3. Specify the request address and request method for the new user form, and add the name attribute to the form item

4. Create a route that implements the function of adding users (ÈªûÊìäsubmitÂæåÁöÑpost Êìç‰Ωú)

5. Receive the request parameters from the client

6. Validate the format of the request parameters

7. Verify whether the current email address to be registered has already been registered

8. Encrypt the password

9. Add user information to the database

10. Redirect the page to the user list page

### 1. ‰∏∫Áî®Êà∑ÂàóË°®È°µÈù¢ÁöÑÊñ∞Â¢ûÁî®Êà∑ÊåâÈíÆÊ∑ªÂä†ÈìæÊé•

- ViewsüìÅ=>adminüìÅ=>commonüìÅ=> user.art

  ```js
   <a href="/admin/user-edit" class="btn btn-primary new">New Users</a> 
  ```

### 2. Ê∑ªÂä†‰∏Ä‰∏™ËøûÊé•ÂØπÂ∫îÁöÑË∑ØÁî±ÔºåÂú®Ë∑ØÁî±Â§ÑÁêÜÂáΩÊï∞‰∏≠Ê∏≤ÊüìÊñ∞Â¢ûÁî®Êà∑Ê®°Êùø

> routerüìÅ ->`admin.js`

  ```js
  //edit page routes
  admin.get("/userEdit", require("./admin/userEdit"));
  ```
> routerüìÅ-> adminüìÅ-> userEdit.js

 ```js
   module.exports = (req, res) => {
     res.render("admin/userEdit");
   };
 ```

ÊâìÂºÄÊµèËßàÂô®Âà∑Êñ∞ÔºåÁÇπÂáªÊñ∞Â¢ûÁî®Êà∑ÔºåÂèëÁé∞ÔºöÂèØ‰ª•Ë∑≥ËΩ¨Âà∞Ë°®ÂçïÈ°µ‰∫Ü„ÄÇ![Screen Shot 2023-02-19 at 9.18.08 AM](/Users/yuimorii/Documents/GitHub/Tokyo-stack-projects/images/user-edit-fomr.png)

### 3. ‰∏∫Êñ∞Â¢ûÁî®Êà∑Ë°®ÂçïÊåáÂÆöËØ∑Ê±ÇÂú∞ÂùÄ„ÄÅËØ∑Ê±ÇÊñπÂºè„ÄÅ‰∏∫Ë°®ÂçïÈ°πÊ∑ªÂä†nameÂ±ûÊÄß

> ViewsüìÅ=>adminüìÅ=>commonüìÅ=> userEdit.art

```html
<form class="form-container" method="post" action="/admin/userEdit">
 
<input name="username" type="text" class="form-control" placeholder="Please enter your username">
 
<input name="email" type="email" class="form-control" placeholder="Please enter your email address">
 
<input name="password" type="password" class="form-control" placeholder="Please enter your password">
 
<select name="role" class="form-control">
         <option value="normal">ÊôÆÈÄöÁî®Êà∑</option>
         <option value="admin">Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò</option>
</select>
 
<select name="state" class="form-control">
         <option value="0">ÂêØÁî®</option>
         <option value="1">Á¶ÅÁî®</option>
</select>
```

### 4. ÂâµÂª∫ÂÆûÁé∞Ê∑ªÂä†Áî®Êà∑ÁöÑÂäüËÉΩË∑ØÁî±(ÈªûÊìäsubmitÂæåÁöÑpost Êìç‰Ωú)

> RouterüìÅ=>adminüìÅ=> userEdit-fn.js

```js
// ÂàõÂª∫ÂÆûÁé∞Ê∑ªÂä†Áî®Êà∑ÂäüËÉΩ
admin.post('/user-Edit', require('./admin/userEdit-fn'));

module.exports = (req, res) => {
  //ÈÄôË£°ÂØ¶ÁèæÁî®Êà∂Ê∑ªÂä†ÂäüËÉΩ
  res.send("ok");
};
```

ÂõûÂà∞ÊµèËßàÂô®Âà∑Êñ∞Ë°®ÂçïÈ°µÈù¢ÔºåÁÇπÂáªÊèê‰∫§ÊåâÈíÆÔºåÂèØ‰ª•ÁúãÂà∞ÔºöÁÄèË¶ΩÂô®È†ÅÈù¢È°ØÁ§∫ok,ËØ¥ÊòéË∑ØÁî±ÂàõÂª∫ÊàêÂäü‰∫Ü„ÄÇ

### 5. Êé•Êî∂Âà∞ÂÆ¢Êà∑Á´Ø‰º†ÈÄíËøáÊù•ÁöÑËØ∑Ê±ÇÂèÇÊï∞

ÁªßÁª≠ÁºñËæë user-edit-fn.js Êñá‰ª∂Ôºö

```js
module.exports = (req, res) => {
  //ÈÄôË£°ÂØ¶ÁèæÁî®Êà∂Ê∑ªÂä†ÂäüËÉΩ
  res.send(req.body);
};
//Âà∑Êñ∞ÊµèËßàÂô®ÔºåÈöè‰æøËæìÂÖ•‰∏Ä‰∫õ‰ø°ÊÅØÔºåÁÇπÂáªÊèê‰∫§„ÄÇÂèØ‰ª•ÁúãÂà∞ÔºöÊé•Êî∂Âà∞ÁöÑËØ∑Ê±ÇÂèÇÊï∞
//{"username":"matthew","email":"matthew@gmail.com","password":"000000","state":"0"}
```

### 6. ÂØπËØ∑Ê±ÇÂèÇÊï∞ÁöÑÊ†ºÂºèËøõË°åÈ™åËØÅ(üò§)

### Joi module üí• @14.3.1 

> ‚ùå**Error**‚ùå:` Joi.validate is not a function` is that this method has been deprecated by joi, and there are two ways to solve it
>
> ```js
> npm uninstall joi
> npm install joi@14.3.1
> ```
>
> way2 : 
>
> ```js
> //ÂºïÂÖ•joiÊ®°Âùó
> const Joi=require('joi')
> 
> module.exports=async(req,res)=>{
> 
>   //ÂÆöÁæ©Â∞çË±°ÁöÑÈ©óË≠âË¶èÂâá
>   const schema = Joi.object({
>     username: Joi.string()
>       .min(2)
>       .max(12)
>       .required()
>       .error(new Error("Invalid username")),
>     email: Joi.string().email().required().error(new Error("Invalid email")),
>     password: Joi.string()
>       .regex(/^[a-zA-Z0-9]{3,30}$/)
>       .required()
>       .error(new Error("Invalid password")),
>     role: Joi.string()
>       .valid("normal", "admin")
>       .required()
>       .error(new Error("Invalid Value")),
>     state: Joi.number()
>       .valid(0, 1)
>       .required()
>       .error(new Error("Invalid status")),
>   });
> })
> ```

![submit add user](https://github.com/itsyuimorii/Tokyo-stack-projects/blob/main/images/user-edit-fomr.png)

> RouteüìÅ=>adminüìÅ=>userEdit-fn.js üëá

```js
const Joi = require("joi");

module.exports = async (req, res) => {
  //ÈÄôË£°ÂØ¶ÁèæÁî®Êà∂Ê∑ªÂä†ÂäüËÉΩ
  // res.send("ok");
  //{"username":"matthew","email":"matthew@gmail.com","password":"000000","state":"0"}

  //Define the validation rules for the object
  const schema = Joi.object({
    username: Joi.string()
      .min(2)
      .max(12)
      .required()
      .error(new Error("Invalid username")),
    email: Joi.string().email().required().error(new Error("Invalid email")),
    password: Joi.string()
      .regex(/^[a-zA-Z0-9]{3,30}$/)
      .required()
      .error(new Error("Invalid password")),
    role: Joi.string()
      .valid("normal", "admin")
      .required()
      .error(new Error("Invalid Value")),
    state: Joi.number()
      .valid(0, 1)
      .required()
      .error(new Error("Invalid status")),
  });
  //Áî®try{}catch(){}ËØ≠Âè•Êù•ÊçïËé∑ÂºÇÊ≠•ÂáΩÊï∞ÁöÑÂºÇÂ∏∏
  try {
    //ÂÆûÊñΩÈ™åËØÅ
    await schema.validateAsync(req.body);
  } catch (e) {
    //È™åËØÅÊ≤°ÊúâÈÄöËøá
    console.log(e.message)
    //ÈáçÂÆöÂêëÂõûÁî®Êà∑Ê∑ªÂä†È°µÈù¢
    return res.redirect(`/admin/userEdit?message = ${e.message}`);
  }
  //ÈÄôË£°Â¶ÇÊûúÂú®ÊúÄÂæåÂØ´‰∫Üres.send(req.body) ÊúÉÂ†±ÈåØ, ÂèØ‰ª•Âú®res.direct Ââç‚ûïreturn ËÆì‰∏ãÈù¢‰ª£Á¢º‰∏çÂü∑Ë°å
  // res.send(req.body);
};
```

> Note: üëÜ‰∏äÈù¢try...catch ÁöÑÊÄùË∑ØÊòØ: 

üí°Âú®/admin/userEdit-fn‰∏≠, Áï∂Áî®Êà∂ÈªûÊìäÊèê‰∫§ÁöÑÊåâÈàï, È†ÅÈù¢Â∞±ÊúÉË∑≥ËΩâ, ÂØ¶Èöõ‰∏äÊòØË∑≥ËΩâÂà∞`/admin/userEdit`È†ÅÈù¢, ÊâÄ‰ª•Âú®user.Edit‰∏≠Ê∏≤Êüì`res.render`, Â∞±ÂèØ‰ª•Âú®artÊñá‰ª∂‰∏≠Âá∫ÁèæÈÄôÂÄãmessage ‰∫Ü 



RouteüìÅ=>adminüìÅ=>userEdit.js üëá

```js
module.exports = (req, res) => {
  const { message } = req.query;
  res.render("admin/userEdit", {
    message: message,
  });
};
```

ViewsüìÅ=>adminüìÅ=>commonüìÅ=> userEdit.art üëá

```js
<p class="tips">{{message}}</p>
```

### 7. Verify that the current email address to be registered has already been registered¬∑

```js
  // Check if the user exists by email address
  let user = await User.findOne({ email: req.body.email });
  // If the user already exists and the email address is already occupied by someone else
  if (user) {
    // Redirects back to the user add page
    return res.redirect(
      `/admin/userEdit?message=The email address is already occupied`
    );
  }
```

### 8. Encryption of passwords, Âú®È©óË≠âÁî®Êà∂Ëº∏ÂÖ•ÁÑ°Ë™§Âæå

```js
  // ÁîüÊàêÈöèÊú∫Â≠óÁ¨¶‰∏≤
  const salt = await bcrypt.genSalt(10);
  // Âä†ÂØÜ
  const password = await bcrypt.hash(req.body.password, salt);
  // ÊõøÊç¢ÂØÜÁ†Å
  req.body.password = password;
  //res.send(req.body);
```

### 9. Adding user information to the database

```js
  // Â∞ÜÁî®Êà∑‰ø°ÊÅØÊ∑ªÂä†Âà∞Êï∞ÊçÆÂ∫ì‰∏≠
  await User.create(req.body);
```

### 10. Redirect page to user list page

```js
  // Â∞ÜÈ°µÈù¢ÈáçÂÆöÂêëÂà∞Áî®Êà∑ÂàóË°®È°µÈù¢
  res.redirect("/admin/user");
```

### 11. ÂÑ™Âåñ‰ª£Á¢º

Âú®model üìÅ‰∏ã`user.js`‰∏≠ 

```js
const validateUser = (user) => {}
```

```js
const Joi = require("joi");

// ÂÆö‰πâÂØπË±°ÁöÑÈ™åËØÅËßÑÂàô
const schema = {
    username: Joi.string()
      .min(2)
      .max(12)
      .required()
      .error(new Error("Invalid username")),
    email: Joi.string().email().required().error(new Error("Invalid email")),
    password: Joi.string()
      .regex(/^[a-zA-Z0-9]{3,30}$/)
      .required()
      .error(new Error("Invalid Password ")),
    role: Joi.string()
      .valid("normal", "admin")
      .required()
      .error(new Error("Invalid role")),
    state: Joi.number()
      .valid(0, 1)
      .required()
      .error(new Error("Invalid status")),
  };

  // ÂÆûÊñΩÈ™åËØÅ
  return Joi.validate(user, schema);
};
```

### 12. error handling `res.redirect `middleware

> app.js

```js
//ÈåØË™§ËôïÁêÜ‰∏≠Èñì‰ª∂
app.use((err, req, res, next) => {
  res.redirect(`/admin/userEdit?message=${e.message}`);
});
```

RouteüìÅ=>adminüìÅ=>userEdit-fn.js üëá

**JSON.stringfy**

```js
  //Áî®try{}catch(){}ËØ≠Âè•Êù•ÊçïËé∑ÂºÇÊ≠•ÂáΩÊï∞ÁöÑÂºÇÂ∏∏
  try {
    await validateUser(req.body);
  } catch (e) {
    // ÈáçÂÆöÂêëÂõûÁî®Êà∑Ê∑ªÂä†È°µÈù¢
		// return res.redirect(`/admin/userEdit?message=${e.message}`);
		// JSON.stringify() Â∞ÜÂØπË±°Êï∞ÊçÆÁ±ªÂûãËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤Êï∞ÊçÆÁ±ªÂûã
		return next(JSON.stringify({path: '/admin/userEdit', message: e.message}))
  }

  // Check if the user exists by email address
  let user = await User.findOne({ email: req.body.email });
  if (user) {
   return next(
      JSON.stringify({
        path: "/admin/user-edit",
        message: "The email address is already occupied",
      })
    );
```

 ¬∑`nextÊñπÊ≥ï`¬∑üí•Only one parameter can be passed, and it is a string type, but now if you need to pass two parameters, the solution is üëá:

1. pass an `argument`, the parameters should be written as `object`. 2, 
2. you need to convert `object` to `string` and put it in the `next()` method

3. Here we use `JSON.stringify()` to convert the object data type to `string` data type

```js
return next(JSON.stringify({path: '/admin/userEdit', message: e.message}))
```

app.js

```js
//ÈåØË™§ËôïÁêÜ‰∏≠Èñì‰ª∂
app.use((err, req, res, next) => {
  //JSON.parse()Â∞áÂ≠óÁ¨¶‰∏≤ËΩâÊèõÁÇ∫Â∞çË±°
  const result = JSON.parse(err)
  
  Â∞áÂéüüà∂Ô∏èÁöÑ
  res.redirect(`/admin/userEdit?message=${e.message}`);
  ÊîπÁÇ∫:
  res.redirect(`${result.path}?message=${result.message}`); 
});
```

## 8. Display user infomation 

When accessing the `user list` page, you need to first query all the `user information` from the `database` in the `route` processing function corresponding to the `user list` page, then use the `res.redner` method to render it, and pass the queried user data to the `template` to display it

> routerüìÅ->admin.js

```js
// Create a user list route
//this route will be based on the "Level 1 route" -admin "Level 2 route"
admin.get("/user", require("./admin/userList"));
```

> routerüìÅ->adminüìÅ->userList.js

```js
//Â∞éÂÖ•Áî®Êà∂ÁµêÂêàÊßãÈÄ†ÂáΩÊï∏
const { User } = require("../../model/user");
module.exports = async (req, res) => {
  // Query the user information from the database
  //users Êé•ÂèóËøîÂõûÁöÑÁµêÊûú
  let users = await User.find({});

  //res.send(users);
  //Ê∏≤ÊüìÁî®Êà∂ÂàóË°®Ê®°Êùø, Â∞áÊé•Êî∂Âà∞ÁöÑÁµêÊûúusersÂÇ≥ÂÖ•Ê®°Êùø‰∏≠, usersÊòØÊï∏ÁµÑ
  res.render("admin/user", {
    users: users,
  });
};
```

> ViewsüìÅ-> user.art

```html
   <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Operation</th>
            </tr>
		</thead>
		<tbody>
           {{each users}}
               <tr>
                    <td>{{$value._id}}</td>
                    <td>{{$value.username}}</td>
                    <td>{{$value.email}}</td>
                    <td>{{$value.role == 'admin' ? 'admin': 'normal'}}</td>
                    <td>{{$value.state == 0 ? 'active': 'disabled'}}</td>
                    <td>  <a href="/admin/userEdit?id={{@$value._id}}" class="glyphicon glyphicon-edit"></a>
                        <i class="glyphicon glyphicon-remove" data-toggle="modal" data-target=".confirm-modal"></i>
                    </td>
                </tr>
     </tbody>
            {{/each}}
</table>
```

## 9. Pagination

When the data in the database is very much, the data needs to be displayed in batches, then you need to use the data paging function.

Paging function core elements.

1. the current page, the user by clicking on the previous page or the next page or page number generated, the client passed to the server through the get parameter way
2. the total number of pages, according to the total number of pages to determine whether the current page is the last page, according to the judgment results to do response operations

> Total number of pages: Math.ceil (total number of data / number of data displayed per page)

### 1. add pagination function

> Router üìÅ-> admin üìÅ--> userList.js

```js
 // 1. Receive the current page parameters from the client
  let page = req.query.page;
  //2. Number of data items displayed per page
  let pagesize = 10;
  //3. Query the total number of user data
  let count = await User.countDocuments({});
  // res.send("The total number of users is: " + count);
  // return;
  //4. Total number of pages
  let total = Math.ceil(count / pagesize);
```

> Êï∞ÊçÆÂºÄÂßãÊü•ËØ¢‰ΩçÁΩÆ=ÔºàÂΩìÂâçÈ°µ-1Ôºâ* ÊØèÈ°µÊòæÁ§∫ÁöÑÊï∞ÊçÆÊù°Êï∞

```js
limit(2) // limit ÈôêÂà∂Êü•ËØ¢Êï∞Èáè  ‰º†ÂÖ•ÊØèÈ°µÊòæÁ§∫ÁöÑÊï∞ÊçÆÊï∞Èáè
skip(1) // skip Ë∑≥ËøáÂ§öÂ∞ëÊù°Êï∞ÊçÆ  ‰º†ÂÖ•ÊòæÁ§∫Êï∞ÊçÆÁöÑÂºÄÂßã‰ΩçÁΩÆ
```

```js
  let start = (page - 1) * pagesize;
  // Query the user information from the database
  let users = await User.find({}).limit(pagesize).skip(start);
```

![pageination](https://github.com/itsyuimorii/Tokyo-stack-projects/blob/main/images/pageination.png)

### 2. ÁîüÊàêÂàÜÈ†ÅÂô®, add a üîó link to the pagination button

When rendering the user list template, you need to pass in the paging information as well

> Router üìÅ-> admin üìÅ--> userList.js

```js
 res.render("admin/user", {
    users: users,
    page: page,
    total: total,
  });
};
```

> ViewsüìÅ-> user.art

```html
<ul class="pagination">
          <li>
              <a href="/admin/user?page=<%=page-0-1%>">
              <span>&laquo;</span>
            </a>
          </li>
          <%for(var i = 1; i <= total; i++ ){ %>
          <li><a href="/admin/user?page=<%=i %>">{{i}}</a></li>
          <% } %>
          <li>
            <a href="/admin/user?page=<%=page-0+1%>">
              <span>&raquo;</span>
            </a>
          </li>
</ul>
```

 add a üîó link to the pagination button

```js
<li><a href="/admin/user?page=<%=i %>">{{i}}</a></li>
```

‚û°Ô∏è button

> ÈÄôË£°ÁöÑÈÅãÁÆóÈúÄË¶ÅÂ∞ápageÂæû`string`ËΩâÊèõÁÇ∫`number` "-0"ÊúâÈö±ÂºèËΩâÊèõÂäüËÉΩ

```js
<a href="/admin/user?page=<%=page-0+1%>">
```

```js
<a href="/admin/user?page=<%=page-0-1%>">           
```

Âà§Êñ∑ÊòØÂê¶Âà∞ÈÅîÊúÄÂæå‰∏ÄÈ†Å

```js
<li style="display: <%=page-1 < 1 ? 'none' : 'inline' %>">
```

```js
<li style="display: <%= page-0+1 > total ? 'none' : 'inline' %>">
```

all code

```js
 <ul class="pagination">
                <li style="display: <%=page-1 < 1 ? 'none' : 'inline' %>">
                    <a href="/admin/user?page=<%=page-1%>">
    		        <span>&laquo;</span>
    		      </a>
                </li>
                <% for (var i = 1; i <= total; i++) { %>
                <li><a href="/admin/user?page=<%=i %>">{{i}}</a></li>
                <% } %>
                <li style="display: <%= page-0+1 > total ? 'none' : 'inline' %>">
                    <a href="/admin/user?page=<%=page-0+1%>">
    		        <span>&raquo;</span>
    		      </a>
                </li>
            </ul>
```

## 10. Userinfo edit

1. Â∞ÜË¶Å‰øÆÊîπÁöÑÁî®Êà∑ID‰º†ÈÄíÂà∞ÊúçÂä°Âô®Á´ØÔºà‰ΩúÁî®ÔºöÂå∫ÂàÜÊ∑ªÂä†Áî®Êà∑ÂäüËÉΩËøòÊòØ‰øÆÊîπÁî®Êà∑ÂäüËÉΩÔºâ

2. Âª∫Á´ãÁî®Êà∑‰ø°ÊÅØ‰øÆÊîπÂäüËÉΩÂØπÂ∫îÁöÑË∑ØÁî±

3. Êé•Êî∂ÂÆ¢Êà∑Á´ØË°®Âçï‰º†ÈÄíËøáÊù•ÁöÑËØ∑Ê±ÇÂèÇÊï∞

4. Ê†πÊçÆidÊü•ËØ¢Áî®Êà∑‰ø°ÊÅØÔºåÂπ∂Â∞ÜÂÆ¢Êà∑Á´Ø‰º†ÈÄíËøáÊù•ÁöÑÂØÜÁ†ÅÂíåÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÂØÜÁ†ÅËøõË°åÊØîÂØπ, 

5. Â¶ÇÊûúÊØîÂØπÂ§±Ë¥•ÔºåÂØπÂÆ¢Êà∑Á´ØÂÅöÂá∫ÂìçÂ∫î

6. Â¶ÇÊûúÂØÜÁ†ÅÂØπÊØîÊàêÂäüÔºåÂ∞ÜÁî®Êà∑‰ø°ÊÅØÊõ¥Êñ∞Âà∞Êï∞ÊçÆÂ∫ì‰∏≠

### 1. Â∞ÜË¶Å‰øÆÊîπÁöÑÁî®Êà∑ID‰º†ÈÄíÂà∞ÊúçÂä°Âô®Á´ØÔºà‰ΩúÁî®ÔºöÂå∫ÂàÜÊ∑ªÂä†Áî®Êà∑ÂäüËÉΩËøòÊòØ‰øÆÊîπÁî®Êà∑ÂäüËÉΩÔºâ

> Âú®Áî®Êà∂ÂàóË°®È†ÅÈù¢Ë£° ViewsüìÅ=>adminüìÅ=>commonüìÅ=> user.art

```js
<a href="/admin/userEdit?id={{@$value._id}}" class="glyphicon glyphicon-edit"></a>
```

- Here determine if there is a corresponding id value, 

  If not, it is to add user information, 

  If there is a function to modify the user information

  ![editsuer](https://github.com/itsyuimorii/Tokyo-stack-projects/blob/main/images/editsuer.png)

  ![editsuer](https://github.com/itsyuimorii/Tokyo-stack-projects/blob/main/images/Screen%20Shot%202023-02-19%20at%2011.01.58%20AM.png)

### 2. Âª∫Á´ãÁî®Êà∑‰ø°ÊÅØ‰øÆÊîπÂäüËÉΩÂØπÂ∫îÁöÑË∑ØÁî±

```js
// ÂºïÂÖ•Áî®Êà∑ÈõÜÂêàÁöÑÊûÑÈÄ†ÂáΩÊï∞
const { User } = require("../../model/user"); // ÂºïÂÖ•Âä†ÂØÜÊ®°Âùó

module.exports = async (req, res) => {
  //Áç≤ÂèñÂà∞Âú∞ÂùÄÊ¨Ñ‰∏≠ÁöÑidÂèÉÊï∏

  const { message, id } = req.query;
  // Ê∑ªÂä†Êìç‰Ωú
  res.render("admin/userEdit", {
    message: message,
  });

  //Â¶ÇÊûúÁï∂ÂâçÂÇ≥ÈÅû‰∫ÜidÂèÉÊï∏,
  if (id) {
    //‰øÆÊîπÊìç‰Ωú
  } else {
    //Ê∑ªÂä†Êìç‰Ωú
  }
};
```

> Click the Modify button to see the user information

![id](https://github.com/itsyuimorii/Tokyo-stack-projects/blob/main/images/id.png)

### 3. Êé•Êî∂ÂÆ¢Êà∑Á´ØË°®Âçï‰º†ÈÄíËøáÊù•ÁöÑËØ∑Ê±ÇÂèÇÊï∞

> routerüìÅ-> adminüìÅ-> userEdit.js

```js

```



### 

### 4. Ê†πÊçÆidÊü•ËØ¢Áî®Êà∑‰ø°ÊÅØÔºåÂπ∂Â∞ÜÂÆ¢Êà∑Á´Ø‰º†ÈÄíËøáÊù•ÁöÑÂØÜÁ†ÅÂíåÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÂØÜÁ†ÅËøõË°åÊØîÂØπ, 

### 5. Â¶ÇÊûúÊØîÂØπÂ§±Ë¥•ÔºåÂØπÂÆ¢Êà∑Á´ØÂÅöÂá∫ÂìçÂ∫î

### 6. Â¶ÇÊûúÂØÜÁ†ÅÂØπÊØîÊàêÂäüÔºåÂ∞ÜÁî®Êà∑‰ø°ÊÅØÊõ¥Êñ∞Âà∞Êï∞ÊçÆÂ∫ì‰∏≠

## Takeaway key points

